<% layout("/layouts/boilerplate") %>

<div class="row " style="overflow: hidden; padding: 10px;"  >
    
    <div class="col-8 offset-2" >
    <h5><b><%= listing.title %></b></h5>
    <div class="card-img">
         
      <img src="<%= listing.image.url %>" class="card-img-top" alt="<%= listing.title %>" style="height: 15rem; object-fit: cover;">
        <%= listing.owner.username %> <br>
        <%= listing.description %> <br>
        &#8377; <%= listing.price.toLocaleString("en-IN") %> <br>
        <%= listing.location %> <br>
        <%= listing.country %> <br>
    
     </div></div><br>
    <% if(currUser && currUser._id.equals(listing.owner._id)) { %>
    <div class="btns col-4 offset-2">    
    <a href="/listing/<%= listing._id %>/edit"><div class="btn btn-outline-danger">edit</div></a>
    <br><br>
    <form method="post" action="/listing/<%= listing._id %>?_method=delete" >
      <button class="btn btn-danger">Delete</button>
    </form>
    </div>
<% } %>
    </div>
 
   <div class="col-8 offset-2 mb-4">
     <% if(currUser){ %>
    <form action="/listing/<%= listing._id %>/reviews" method="post" novalidate class="needs-validation">
    <h5>Leave a Review</h5>
    <div class="mb-3 mt-3">
      <label for="ratings" class="form-label" id="rating">Rating :</label>
      <div class="star-rating">
        <input type="radio" id="star5" name="review[rating]" value="5" />
        <label for="star5" title="5 stars"></label>
        <input type="radio" id="star4" name="review[rating]" value="4" />
        <label for="star4" title="4 stars"></label>
        <input type="radio" id="star3" name="review[rating]" value="3" />
        <label for="star3" title="3 stars"></label>
        <input type="radio" id="star2" name="review[rating]" value="2" />
        <label for="star2" title="2 stars"></label>
        <input type="radio" id="star1" name="review[rating]" value="1" />
        <label for="star1" title="1 star"></label>
      </div>
    </div>
    <div>
      <label for="comment" class="form-label">Comment :</label>   
      <textarea name="review[comment]" id="comment" rows="3" cols="2" class="form-control" required ></textarea>
      <div class="invalid-feedback">please comment</div>
      <button class="btn btn-outline-dark mt-2">Submit</button>
    </div>
    </form>
    <% } %>
    <hr>
    <p><b>All reviews</b></p>
    <div class="row">
    <% for(review of listing.reviews) { %>
        <div class="col-6 col-lg-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-title"><%= review.author.username %></h6>
                    <div class="review-stars mb-2">
                        <% for(let i = 1; i <= 5; i++) { %>
                            <span class="<%= i <= review.rating ? 'star' : 'empty-star' %>">â˜…</span>
                        <% } %>
                    </div>
                    <figure>
                        <blockquote class="blockquote">
                            <p><%= review.comment %></p>
                        </blockquote>
                    </figure>
                    <% if(currUser && currUser._id.equals(review.author._id)) { %>
                    <form action="/listing/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" method="post">
                      <button class="btn btn-sm btn-danger">Delete</button>
                    </form>
                    <% } %>
                </div>
            </div>
        </div>
    <% } %>
</div>
   </div>

   <!-- Map Section -->
   <div class="col-8 offset-2 mb-4">
       <hr>
       <h5><b>Where you'll be</b></h5>
       <div class="map-container">
           <div id="map" style="height: 400px; border-radius: 12px; overflow: hidden;"></div>
       </div>
       <div class="location-info mt-3">
           <h6><%= listing.location %>, <%= listing.country %></h6>
           <p class="text-muted">Exact location information is provided after booking confirmation.</p>
       </div>
   </div>

<script>
    // Initialize map using Mapbox (free alternative) or OpenStreetMap
    const mapToken = 'pk.eyJ1IjoiZGV2ZWxvcGVyLW5pdGluIiwiYSI6ImNtNGYxbGlqeTA3NnoyaXNsdm45MnNhbmMifQ.BUG2UoN4Uj2hN9_ZwjCYjw'; // You'll need to get your own token
    
    // Initialize the map
    mapboxgl.accessToken = mapToken;
    
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [77.2090, 28.6139], // Default to Delhi coordinates
        zoom: 10
    });
    
    // Geocode the location
    const location = '<%= listing.location %>, <%= listing.country %>';
    
    // Use Mapbox Geocoding API to get coordinates
    fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(location)}.json?access_token=${mapToken}`)
        .then(response => response.json())
        .then(data => {
            if (data.features && data.features.length > 0) {
                const coordinates = data.features[0].center;
                
                // Update map center
                map.setCenter(coordinates);
                map.setZoom(12);
                
                // Add marker
                new mapboxgl.Marker({
                    color: '#ff385c'
                })
                .setLngLat(coordinates)
                .setPopup(new mapboxgl.Popup().setHTML(`
                    <div class="map-popup">
                        <h6><%= listing.title %></h6>
                        <p><%= listing.location %>, <%= listing.country %></p>
                    </div>
                `))
                .addTo(map);
            }
        })
        .catch(error => {
            console.log('Geocoding error:', error);
            // Fallback: just show a marker at default location
            new mapboxgl.Marker({
                color: '#ff385c'
            })
            .setLngLat([77.2090, 28.6139])
            .setPopup(new mapboxgl.Popup().setHTML(`
                <div class="map-popup">
                    <h6><%= listing.title %></h6>
                    <p><%= listing.location %>, <%= listing.country %></p>
                </div>
            `))
            .addTo(map);
        });
    
    // Add map controls
    map.addControl(new mapboxgl.NavigationControl());
</script>

<style>
    .map-container {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-radius: 12px;
        overflow: hidden;
    }
    
    .location-info h6 {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .map-popup {
        text-align: center;
        padding: 5px;
    }
    
    .map-popup h6 {
        margin: 0 0 5px 0;
        font-size: 14px;
        font-weight: 600;
    }
    
    .map-popup p {
        margin: 0;
        font-size: 12px;
        color: #666;
    }
    
    .mapboxgl-popup-content {
        border-radius: 8px;
        padding: 10px;
    }
</style>
